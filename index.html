<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tiket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <script>
        // Pengecekan otentikasi agar berjalan paling awal
        if (!localStorage.getItem('authToken')) { 
            window.location.href = './login.html'; 
        }
    </script>

    <div class="wrapper">
        <nav id="sidebar" class="d-flex flex-column p-3">
            <div>
                <h4 class="mb-4 text-center">Dashboard</h4>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#running" id="nav-running"><i class="bi bi-person-workspace"></i> <span>Tiket Running</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="#closed" id="nav-closed"><i class="bi bi-check2-circle"></i> <span>Tiket Closed</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="#stats" id="nav-stats"><i class="bi bi-bar-chart-line"></i> <span>Statistik</span></a></li>
                </ul>
            </div>
            <div class="mt-auto">
                <hr class="text-secondary">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#profile" id="nav-profile"><i class="bi bi-person-circle"></i> <span>Profil</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-left"></i> <span>Logout</span></a></li>
                </ul>
            </div>
        </nav>
        <div id="sidebar-overlay" onclick="hideSidebar()"></div>
        <div id="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <div class="d-flex align-items-center">
                    <button class="btn btn-dark me-3" id="sidebar-toggle"><i class="bi bi-list"></i></button>
                    <h1 id="page-title" class="h3 mb-0">Dashboard Monitoring Tiket MS & SQUAT</h1>
                </div>
                <div class="btn-group" id="main-actions">
                    <button type="button" class="btn btn-success" id="export-btn" onclick="exportClosedTickets()" style="display: none;"><i class="bi bi-file-earmark-excel"></i> Export to Excel</button>
                    <button type="button" class="btn btn-secondary" id="manage-technicians-btn" data-bs-toggle="modal" data-bs-target="#techniciansModal" onclick="fetchTechnicians()">Daftar Teknisi</button>
                    <button type="button" class="btn btn-info text-white" onclick="generateReport()">Generate Laporan</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTicketModal" id="add-ticket-btn">+ Tambah Tiket</button>
                </div>
            </div>

            <div id="date-filter-container" class="row g-3 mb-3 align-items-end" style="display: none;">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Dari Tanggal</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Sampai Tanggal</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
                <div class="col-md-auto">
                    <button class="btn btn-primary" onclick="applyDateFilter()">Filter</button>
                    <button class="btn btn-outline-secondary ms-2" onclick="clearDateFilter()">Reset</button>
                </div>
            </div>

            <div id="content-area"></div>
        </div>
    </div>
    
    <div class="modal fade" id="addTicketModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Form Tiket Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addTicketForm"><div class="mb-3"><label for="category" class="form-label">Kategori Tiket</label><select class="form-select" id="category" required><option value="" selected disabled>Pilih Kategori...</option><option value="SQUAT">SQUAT</option><option value="MTEL">MTEL</option><option value="UMT">UMT</option><option value="CENTRATAMA">CENTRATAMA</option></select></div><div class="mb-3"><label for="subcategory" class="form-label">Sub-kategori</label><select class="form-select" id="subcategory" required disabled><option value="" selected disabled>Pilih Kategori dulu...</option></select></div><div class="mb-3"><label for="id_tiket" class="form-label">ID Tiket</label><input type="text" class="form-control" id="id_tiket" required></div><div class="mb-3"><label for="tiket_time" class="form-label">Waktu Tiket</label><input type="datetime-local" class="form-control" id="tiket_time" required></div><div class="mb-3"><label for="deskripsi" class="form-label">Deskripsi</label><textarea class="form-control" id="deskripsi" rows="3" required></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" onclick="handleFormSubmit()">Simpan Tiket</button></div></div></div></div>
    <div class="modal fade" id="updateTicketModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Update Progres Tiket</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="updateTicketForm"><input type="hidden" id="update_ticket_id"><div class="mb-3"><label for="update_category" class="form-label">Kategori Tiket</label><select class="form-select" id="update_category" required><option value="SQUAT">SQUAT</option><option value="MTEL">MTEL</option><option value="UMT">UMT</option><option value="CENTRATAMA">CENTRATAMA</option></select></div><div class="mb-3"><label for="update_subcategory" class="form-label">Sub-kategori</label><select class="form-select" id="update_subcategory" required></select></div><div class="mb-3"><label for="update_id_tiket_display" class="form-label">ID Tiket</label><input type="text" class="form-control" id="update_id_tiket_display" disabled></div><div class="mb-3"><label for="update_status" class="form-label">Status</label><select class="form-select" id="update_status"><option value="OPEN">OPEN</option><option value="SC">SC</option><option value="CLOSED">CLOSED</option></select></div><div class="mb-3"><label class="form-label">Teknisi (Max. 5)</label><div id="technician-checkboxes-update" class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;"></div></div><div class="mb-3"><label for="update_progres" class="form-label">Update Progres</label><textarea class="form-control" id="update_progres" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" onclick="handleUpdateSubmit()">Simpan Perubahan</button></div></div></div></div>
    <div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Laporan Tiket Dibuat</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control" id="report-textarea" readonly></textarea></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button><button type="button" class="btn btn-primary" onclick="copyReportToClipboard()">Copy Laporan</button></div></div></div></div>
    <div class="modal fade" id="techniciansModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Manajemen Teknisi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="table-responsive"><table class="table"><thead><tr><th>NIK</th><th>Nama</th><th>No. HP</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="technicians-table-body"></tbody></table></div><hr><h6 class="mb-3">Tambah Teknisi Baru</h6><form id="addTechnicianForm" class="row g-3 align-items-end"><div class="col"><label for="tech_nik" class="form-label">NIK</label><input type="text" class="form-control" id="tech_nik" required maxlength="8"></div><div class="col"><label for="tech_name" class="form-label">Nama</label><input type="text" class="form-control" id="tech_name" required></div><div class="col"><label for="tech_phone" class="form-label">No. HP</label><input type="text" class="form-control" id="tech_phone"></div><div class="col-auto"><button type="submit" class="btn btn-primary">Tambah</button></div></form></div></div></div></div>
    <div class="modal fade" id="editTechnicianModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Teknisi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="editTechnicianForm"><input type="hidden" id="edit_tech_nik"><div class="mb-3"><label for="edit_tech_name" class="form-label">Nama</label><input type="text" class="form-control" id="edit_tech_name" required></div><div class="mb-3"><label for="edit_tech_phone" class="form-label">No. HP</label><input type="text" class="form-control" id="edit_tech_phone"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="save-edit-tech-btn">Simpan</button></div></div></div></div>
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="historyModalTitle">Riwayat Perubahan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="historyModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        // Sidebar toggle logic
        function isMobile() {
            return window.innerWidth <= 991;
        }
        function showSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (isMobile()) {
                sidebar.classList.add('show');
                overlay.style.display = 'block';
            } else {
                sidebar.classList.toggle('collapsed');
                document.getElementById('main-content').classList.toggle('sidebar-collapsed');
            }
        }
        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('show');
            overlay.style.display = 'none';
        }
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            showSidebar();
        });
        // Hide sidebar on resize if not mobile
        window.addEventListener('resize', function() {
            if (!isMobile()) {
                document.getElementById('sidebar').classList.remove('show');
                document.getElementById('sidebar-overlay').style.display = 'none';
            }
        });
        // Hide sidebar when clicking a menu (on mobile)
        document.querySelectorAll('#sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (isMobile()) hideSidebar();
            });
        });

        // Highlight active menu
        function setActiveNav() {
            const hash = window.location.hash || '#running';
            document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active'));
            if (hash.startsWith('#running')) document.getElementById('nav-running').classList.add('active');
            else if (hash.startsWith('#closed')) document.getElementById('nav-closed').classList.add('active');
            else if (hash.startsWith('#stats')) document.getElementById('nav-stats').classList.add('active');
            else if (hash.startsWith('#profile')) document.getElementById('nav-profile').classList.add('active');
        }
        window.addEventListener('hashchange', setActiveNav);
        window.addEventListener('DOMContentLoaded', setActiveNav);
    </script>
</body>
</html>